<?php
/**
 * üîç Script de diagnostic complet des emails
 * V√©rifie pourquoi l'email n'arrive pas
 */

// Configuration
$config = [
    'api_url' => 'https://api.wozif.com',
    'target_email' => 'yohankoffik225@gmail.com',
    'mailtrap_config' => [
        'host' => 'live.smtp.mailtrap.io',
        'port' => 587,
        'username' => 'smtp@mailtrap.io',
        'password' => 'c368936fe291afb61199670a97562ab5'
    ]
];

// Couleurs pour l'affichage
class Colors {
    const GREEN = "\033[32m";
    const RED = "\033[31m";
    const YELLOW = "\033[33m";
    const BLUE = "\033[34m";
    const PURPLE = "\033[35m";
    const CYAN = "\033[36m";
    const WHITE = "\033[37m";
    const BOLD = "\033[1m";
    const RESET = "\033[0m";
}

function printColor($text, $color = Colors::WHITE) {
    echo $color . $text . Colors::RESET;
}

function testEndpoint($url, $method = 'POST', $data = null) {
    $ch = curl_init();
    
    curl_setopt_array($ch, [
        CURLOPT_URL => $url,
        CURLOPT_RETURNTRANSFER => true,
        CURLOPT_TIMEOUT => 30,
        CURLOPT_FOLLOWLOCATION => true,
        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
        CURLOPT_CUSTOMREQUEST => $method,
        CURLOPT_HTTPHEADER => [
            'Content-Type: application/json',
            'Accept: application/json',
            'User-Agent: Coovia-Email-Diagnostic/1.0'
        ]
    ]);
    
    if ($data) {
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($data));
    }
    
    $response = curl_exec($ch);
    $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
    $error = curl_error($ch);
    $info = curl_getinfo($ch);
    curl_close($ch);
    
    return [
        'success' => $response !== false && $error === '',
        'http_code' => $httpCode,
        'response' => $response,
        'error' => $error,
        'info' => $info
    ];
}

// Test de connectivit√© SMTP
function testSMTPConnection() {
    global $config;
    
    printColor("üîå Test de connectivit√© SMTP Mailtrap...\n", Colors::BOLD);
    
    $host = $config['mailtrap_config']['host'];
    $port = $config['mailtrap_config']['port'];
    
    printColor("   üì° Connexion √† $host:$port... ", Colors::CYAN);
    
    $socket = @fsockopen($host, $port, $errno, $errstr, 10);
    
    if ($socket) {
        printColor("‚úÖ OK\n", Colors::GREEN);
        fclose($socket);
        return true;
    } else {
        printColor("‚ùå √âCHEC\n", Colors::RED);
        printColor("     Erreur: $errstr ($errno)\n", Colors::RED);
        return false;
    }
}

// Test de l'API d'envoi d'email
function testEmailAPI() {
    global $config;
    
    printColor("üìß Test de l'API d'envoi d'email...\n", Colors::BOLD);
    
    // Test 1: Validation email
    printColor("   üîç Test validation email... ", Colors::CYAN);
    $validationData = ['email' => $config['target_email']];
    $result = testEndpoint($config['api_url'] . '/api/auth/validate-email', 'POST', $validationData);
    
    if ($result['success'] && $result['http_code'] === 200) {
        $response = json_decode($result['response'], true);
        if ($response && $response['success']) {
            printColor("‚úÖ OK\n", Colors::GREEN);
            printColor("     Token: " . substr($response['temp_token'], 0, 10) . "...\n", Colors::WHITE);
        } else {
            printColor("‚ùå √âCHEC\n", Colors::RED);
        }
    } else {
        printColor("‚ùå √âCHEC\n", Colors::RED);
    }
    
    // Test 2: Inscription (d√©clenche l'envoi)
    printColor("   üìù Test inscription... ", Colors::CYAN);
    $registerData = [
        'name' => 'Test Diagnostic',
        'email' => $config['target_email'],
        'password' => 'password123',
        'password_confirmation' => 'password123'
    ];
    
    $result = testEndpoint($config['api_url'] . '/api/auth/register', 'POST', $registerData);
    
    if ($result['success'] && $result['http_code'] === 200) {
        $response = json_decode($result['response'], true);
        if ($response && $response['success']) {
            printColor("‚úÖ OK\n", Colors::GREEN);
            printColor("     Utilisateur cr√©√©: " . $response['user']['id'] . "\n", Colors::WHITE);
            return true;
        } else {
            printColor("‚ùå √âCHEC\n", Colors::RED);
            if (isset($response['message'])) {
                printColor("     Message: " . $response['message'] . "\n", Colors::RED);
            }
        }
    } else {
        printColor("‚ùå √âCHEC\n", Colors::RED);
        if ($result['error']) {
            printColor("     Erreur: " . $result['error'] . "\n", Colors::RED);
        }
    }
    
    return false;
}

// Test de la configuration Mailtrap
function testMailtrapConfig() {
    global $config;
    
    printColor("üìã V√©rification de la configuration Mailtrap...\n", Colors::BOLD);
    
    $config = $config['mailtrap_config'];
    
    printColor("   üè† Host: " . $config['host'] . "\n", Colors::WHITE);
    printColor("   üö™ Port: " . $config['port'] . "\n", Colors::WHITE);
    printColor("   üë§ Username: " . $config['username'] . "\n", Colors::WHITE);
    printColor("   üîë Password: " . substr($config['password'], 0, 8) . "...\n", Colors::WHITE);
    
    // V√©rification des bonnes pratiques
    if ($config['port'] == 587) {
        printColor("   üîí Port 587 (TLS) ‚úÖ\n", Colors::GREEN);
    } else {
        printColor("   ‚ö†Ô∏è Port non standard: " . $config['port'] . "\n", Colors::YELLOW);
    }
    
    if (strpos($config['host'], 'mailtrap') !== false) {
        printColor("   üìß Host Mailtrap ‚úÖ\n", Colors::GREEN);
    } else {
        printColor("   ‚ö†Ô∏è Host non Mailtrap\n", Colors::YELLOW);
    }
}

// Test de l'√©tat de l'utilisateur
function checkUserStatus() {
    global $config;
    
    printColor("üë§ V√©rification de l'√©tat de l'utilisateur...\n", Colors::BOLD);
    
    $result = testEndpoint($config['api_url'] . '/api/users');
    
    if ($result['success'] && $result['http_code'] === 200) {
        $response = json_decode($result['response'], true);
        if ($response && isset($response['users'])) {
            $user = null;
            foreach ($response['users'] as $u) {
                if ($u['email'] === $config['target_email']) {
                    $user = $u;
                    break;
                }
            }
            
            if ($user) {
                printColor("   ‚úÖ Utilisateur trouv√©\n", Colors::GREEN);
                printColor("     ID: " . $user['id'] . "\n", Colors::WHITE);
                printColor("     Nom: " . $user['name'] . "\n", Colors::WHITE);
                printColor("     Email: " . $user['email'] . "\n", Colors::WHITE);
                printColor("     Cr√©√© le: " . $user['created_at'] . "\n", Colors::WHITE);
                return $user;
            } else {
                printColor("   ‚ùå Utilisateur non trouv√©\n", Colors::RED);
            }
        }
    } else {
        printColor("   ‚ùå Impossible de r√©cup√©rer les utilisateurs\n", Colors::RED);
    }
    
    return null;
}

// Test de connexion avec OTP
function testLoginWithOTP() {
    global $config;
    
    printColor("üîê Test de connexion (v√©rification OTP)...\n", Colors::BOLD);
    
    $loginData = [
        'email' => $config['target_email'],
        'password' => 'password123'
    ];
    
    $result = testEndpoint($config['api_url'] . '/api/auth/login', 'POST', $loginData);
    
    if ($result['success']) {
        $response = json_decode($result['response'], true);
        if ($response && $response['success'] === false && isset($response['errors']['otp'])) {
            printColor("   ‚úÖ OTP requis (normal)\n", Colors::GREEN);
            printColor("     Le syst√®me attend un code OTP\n", Colors::CYAN);
            printColor("     Cela confirme que l'email a √©t√© envoy√©\n", Colors::CYAN);
            return true;
        } else {
            printColor("   ‚ö†Ô∏è R√©ponse inattendue\n", Colors::YELLOW);
            printColor("     Message: " . ($response['message'] ?? 'Aucun message') . "\n", Colors::WHITE);
        }
    } else {
        printColor("   ‚ùå Erreur de connexion\n", Colors::RED);
    }
    
    return false;
}

// Diagnostic principal
function runDiagnostic() {
    global $config;
    
    echo "\n";
    printColor("üîç DIAGNOSTIC COMPLET DES EMAILS\n", Colors::BOLD . Colors::PURPLE);
    printColor("==================================\n", Colors::PURPLE);
    echo "\n";
    
    printColor("üéØ Email cible: " . $config['target_email'] . "\n", Colors::CYAN);
    printColor("üìÖ Timestamp: " . date('Y-m-d H:i:s') . "\n", Colors::WHITE);
    echo "\n";
    
    // Test 1: Configuration Mailtrap
    testMailtrapConfig();
    echo "\n";
    
    // Test 2: Connectivit√© SMTP
    $smtpOK = testSMTPConnection();
    echo "\n";
    
    // Test 3: API d'envoi d'email
    $emailSent = testEmailAPI();
    echo "\n";
    
    // Test 4: √âtat de l'utilisateur
    $user = checkUserStatus();
    echo "\n";
    
    // Test 5: V√©rification OTP
    $otpRequired = testLoginWithOTP();
    echo "\n";
    
    // R√©sum√© et diagnostic
    printColor("üìä DIAGNOSTIC FINAL\n", Colors::BOLD . Colors::BLUE);
    printColor("====================\n", Colors::BLUE);
    echo "\n";
    
    printColor("üîå Connectivit√© SMTP: ", Colors::WHITE);
    printColor(($smtpOK ? "‚úÖ OK" : "‚ùå √âCHEC") . "\n", $smtpOK ? Colors::GREEN : Colors::RED);
    
    printColor("üìß Envoi d'email: ", Colors::WHITE);
    printColor(($emailSent ? "‚úÖ OK" : "‚ùå √âCHEC") . "\n", $emailSent ? Colors::GREEN : Colors::RED);
    
    printColor("üë§ Utilisateur cr√©√©: ", Colors::WHITE);
    printColor(($user ? "‚úÖ OUI" : "‚ùå NON") . "\n", $user ? Colors::GREEN : Colors::RED);
    
    printColor("üîê OTP requis: ", Colors::WHITE);
    printColor(($otpRequired ? "‚úÖ OUI" : "‚ùå NON") . "\n", $otpRequired ? Colors::GREEN : Colors::RED);
    
    echo "\n";
    
    // Analyse des probl√®mes
    printColor("üí° ANALYSE DES PROBL√àMES:\n", Colors::BOLD);
    
    if (!$smtpOK) {
        printColor("   ‚ùå Probl√®me de connectivit√© SMTP\n", Colors::RED);
        printColor("      ‚Ä¢ V√©rifiez votre connexion internet\n", Colors::WHITE);
        printColor("      ‚Ä¢ V√©rifiez que le port 587 n'est pas bloqu√©\n", Colors::WHITE);
    }
    
    if (!$emailSent) {
        printColor("   ‚ùå Probl√®me d'envoi d'email\n", Colors::RED);
        printColor("      ‚Ä¢ V√©rifiez la configuration Mailtrap\n", Colors::WHITE);
        printColor("      ‚Ä¢ V√©rifiez les logs Laravel\n", Colors::WHITE);
    }
    
    if (!$user) {
        printColor("   ‚ùå Utilisateur non cr√©√©\n", Colors::RED);
        printColor("      ‚Ä¢ Probl√®me dans la base de donn√©es\n", Colors::WHITE);
        printColor("      ‚Ä¢ V√©rifiez les migrations\n", Colors::WHITE);
    }
    
    if (!$otpRequired) {
        printColor("   ‚ùå OTP non requis\n", Colors::RED);
        printColor("      ‚Ä¢ L'email n'a peut-√™tre pas √©t√© envoy√©\n", Colors::WHITE);
        printColor("      ‚Ä¢ Probl√®me de configuration OTP\n", Colors::WHITE);
    }
    
    echo "\n";
    
    // Solutions recommand√©es
    printColor("üöÄ SOLUTIONS RECOMMAND√âES:\n", Colors::BOLD);
    
    if ($smtpOK && $emailSent && $user && $otpRequired) {
        printColor("   üéâ Tout fonctionne ! L'email a √©t√© envoy√©\n", Colors::GREEN);
        printColor("   üìß V√©rifiez vos spams et dossiers sp√©ciaux\n", Colors::WHITE);
        printColor("   ‚è∞ Attendez quelques minutes (d√©lai d'envoi)\n", Colors::WHITE);
    } else {
        printColor("   üîß V√©rifiez la configuration Mailtrap\n", Colors::YELLOW);
        printColor("   üìù Consultez les logs Laravel sur Forge\n", Colors::YELLOW);
        printColor("   üóÑÔ∏è V√©rifiez la base de donn√©es\n", Colors::YELLOW);
        printColor("   üîÑ Red√©marrez les services sur Forge\n", Colors::YELLOW);
    }
    
    echo "\n";
    
    return $smtpOK && $emailSent && $user && $otpRequired;
}

// Ex√©cution du diagnostic
if (php_sapi_name() === 'cli') {
    $success = runDiagnostic();
    exit($success ? 0 : 1);
} else {
    echo "Ce script doit √™tre ex√©cut√© en ligne de commande.\n";
    echo "Usage: php diagnostic-email.php\n";
}
?>
